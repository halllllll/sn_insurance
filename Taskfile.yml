# https://taskfile.dev

version: '3'

dotenv: [".env"]

vars:
  # APP_URL: 
  # CONTENT_TYPE: "Content-Type: application/json"
  APP_NAME: sn-insurance
  BIND_HOST: '{{.BIND_HOST | default "localhost"}}'
  BASE_URL: http://{{.BIND_HOST}}:9991

tasks:
  dev:
    desc: Start dev server
    run: once
    deps:
      - task: dev:frontend
      - task: dev:backend

  dev:frontend:
    desc: Start frontend server
    run: once
    dir: ./frontend
    deps:
      - frontend:install-deps
    cmd: bun run dev

  frontend:install-deps:
    desc: Install dependencies
    run: once
    dir: ./frontend
    cmd: bun i

  dev:backend:
    desc: Start backend server
    run: once
    deps:
      - backend:install-deps
    cmd: air
  
  backend:install-deps:
    desc: Prepare module
    run: once
    cmd: go mod tidy

  build:
    desc: build code
    run: once
    deps:
      - task: frontend:build
    cmds:
      - task: backend:build

  frontend:build:
    desc: build frontend code
    dir: ./frontend
    cmds:
      - bun i
      - bun run build
  
  backend:build:
    desc: build pocketbase code
    cmd: go build -ldflags='-s -w' -trimpath -o {{.APP_NAME}}

  up:
    desc: execute pocketbase app
    cmd: ./{{.APP_NAME}} serve --http={{.BIND_HOST}}:9991

  dev:health:
    desc: server health check
    cmds:
      - curl -v {{.BASE_URL}}/api/health | jq

  health:
    desc: server health check
    cmds:
      - curl -v {{.APP_URL}}/api/health | jq

  docker:build:
    desc: Build Docker image (Alpine version)
    cmd: docker compose build --no-cache
